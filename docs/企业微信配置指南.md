# 企业微信机器人配置指南

本文档指导您如何配置企业微信机器人，实现理财助手的消息推送功能。

## 1. 创建企业微信群机器人

### 步骤一：创建群聊
1. 打开企业微信电脑版或手机版
2. 创建一个新的群聊（或使用现有群聊）
3. 建议创建一个专门用于接收理财通知的群

### 步骤二：添加群机器人
1. 在群聊中，点击右上角的 **「...」** 或 **群设置**
2. 选择 **「群机器人」** → **「添加群机器人」**
3. 点击 **「新创建一个机器人」**
4. 输入机器人名称，如 **「理财助手」**
5. 点击 **「添加」**

### 步骤三：获取Webhook地址
1. 创建成功后，会显示机器人的 **Webhook地址**
2. 复制这个地址，格式类似：
   ```
   https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
   ```
3. **重要**：请妥善保管此地址，不要泄露给他人

## 2. 配置系统

### 方式一：环境变量配置（推荐）

编辑 `.env` 文件，添加：

```bash
# 企业微信机器人Webhook地址
WECOM_WEBHOOK=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=您的密钥
```

### 方式二：直接修改配置文件

编辑 `config/settings.py`，找到 `Notification` 类，修改：

```python
WECOM_WEBHOOK = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=您的密钥"
```

## 3. 测试配置

运行测试命令：

```bash
python -c "from src.notify import wecom_bot; wecom_bot.send_test_message()"
```

或者在交互模式下：

```bash
python main.py
> test_wecom
```

如果配置正确，您的企业微信群会收到一条测试消息。

## 4. 消息类型说明

系统支持以下消息类型：

### 文本消息
普通的纯文本消息，适用于简单通知。

### Markdown消息
支持标题、列表、链接等格式，用于发送每日报告。

支持的Markdown语法：
- 标题：`# 一级标题`、`## 二级标题`
- 加粗：`**粗体**`
- 链接：`[链接文字](URL)`
- 引用：`> 引用文字`
- 代码：`` `代码` ``
- 列表：`- 列表项`
- 颜色文字：
  - 绿色：`<font color="info">绿色文字</font>`
  - 灰色：`<font color="comment">灰色文字</font>`
  - 橙红：`<font color="warning">橙红文字</font>`

### 卡片消息
图文卡片消息，包含标题、描述和跳转链接。

## 5. 通知场景

| 场景 | 消息类型 | 发送时间 |
|-----|---------|---------|
| 每日报告 | Markdown | 每日18:00 |
| 市场预警 | 文本 | 实时 |
| 止盈止损提醒 | Markdown | 实时 |
| 买入建议 | Markdown | 分析完成后 |
| 系统异常 | 文本 | 实时 |

## 6. 常见问题

### Q: 消息发送失败怎么办？
A: 请检查：
1. Webhook地址是否正确
2. 网络是否能访问企业微信服务器
3. 查看日志文件中的错误信息

### Q: 如何修改通知时间？
A: 编辑 `scheduler.py` 中的定时任务配置。

### Q: 消息内容太长被截断？
A: 企业微信单条消息有长度限制（约4096字符），系统会自动截取摘要。

### Q: 可以@指定成员吗？
A: 可以，在消息中添加 `<@userid>` 即可@指定成员。

## 7. 安全建议

1. **不要公开Webhook地址**：任何人拿到地址都可以发送消息
2. **定期轮换密钥**：如果怀疑泄露，可以在群设置中重新生成
3. **限制IP白名单**：企业微信后台可以设置IP白名单
