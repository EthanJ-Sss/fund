# 基金推荐算法详解

## 一、整体流程概览

基金推荐系统采用 **"漏斗式"** 多阶段筛选架构，从万级基金池逐步收敛到最终推荐列表：

```
全量基金池 (~26,000 只)
    │
    ▼ ① 平台可购过滤
可购基金 (~20,000 只)
    │
    ▼ ② 类型分类
股票型 / 混合型 / 指数型 / 债券型 ...
    │
    ▼ ③ 数据采集（每类取前 200 只）
获取净值历史 + 基本信息
    │
    ▼ ④ 多因子计算（7 大类因子）
收益、风险、风险调整收益、规模、动量、经理、风格
    │
    ▼ ⑤ 预筛选（4433 法则 + 硬性指标）
过滤不达标基金
    │
    ▼ ⑥ 加权评分（按基金类型差异化配权）
0-100 分综合评分
    │
    ▼ ⑦ 排名输出
按综合评分降序排列，输出推荐列表
```

---

## 二、第一阶段：可购基金过滤

> 代码位置：`src/collector/alipay_filter.py` → `AlipayFundFilter`

从天天基金获取全量基金列表后，排除不适合在支付宝等平台购买的基金：

### 排除规则

| 规则 | 说明 | 示例 |
|------|------|------|
| 名称关键词排除 | 排除封闭期、定开型等流动性差的基金 | 封闭、定开、定期开放、持有期、三年、五年、LOF、分级 |
| 代码前缀排除 | 排除场内基金（ETF，代码以 5 开头） | 场内 ETF 无法在支付宝购买 |
| 类型白名单 | 只保留主流公募类型 | 股票型、混合型、债券型、指数型、货币型、QDII、FOF |

### 类型分类映射

过滤后的基金按 `type` 字段中的关键词分类：

| 分类键 | 匹配关键词 | 说明 |
|--------|-----------|------|
| 股票型 | 包含"股票" | 主动/被动股票基金 |
| 混合型 | 包含"混合" | 偏股混合、灵活配置等 |
| 债券型 | 包含"债券" | 纯债、一级债基、二级债基等 |
| 指数型 | 包含"指数"或"联接" | 指数基金、ETF 联接基金 |

---

## 三、第二阶段：数据采集与指标计算

> 代码位置：`src/processor/fund_processor.py` → `FundDataProcessor`

对每只候选基金，通过 AKShare 获取：
- **历史净值数据**（单位净值走势）
- **基金基本信息**（规模、成立时间、基金经理等）

### 3.1 净值数据标准化

将不同数据源的净值数据统一为标准格式：

| 字段 | 说明 |
|------|------|
| `date` | 净值日期 |
| `nav` | 单位净值 |
| `acc_nav` | 累计净值 |

处理流程：识别列名 → 类型转换 → 去重 → 排序 → 去空值

### 3.2 收益率计算

基于净值序列计算各期收益率：

```
收益率 = (最新净值 / 起始净值 - 1) × 100%
```

| 周期代码 | 含义 | 回看天数 |
|----------|------|----------|
| `1d` | 日收益 | 1 天 |
| `1w` | 周收益 | 7 天 |
| `1m` | 月收益 | 30 天 |
| `3m` | 季度收益 | 90 天 |
| `6m` | 半年收益 | 180 天 |
| `1y` | 年度收益 | 365 天 |
| `2y` | 两年收益 | 730 天 |
| `3y` | 三年收益 | 1095 天 |
| `ytd` | 今年以来 | 年初至今 |

### 3.3 风险指标计算

| 指标 | 公式 | 说明 |
|------|------|------|
| **年化波动率** | `σ_daily × √250 × 100%` | 日收益率标准差年化，衡量价格波动幅度 |
| **最大回撤** | `min((累计净值 - 历史最高) / 历史最高)` | 从最高点到最低点的最大跌幅，衡量极端风险 |
| **夏普比率** | `(R_annual - R_f) / σ_annual` | 每承担一单位风险获得的超额收益；R_f = 2.5% |
| **索提诺比率** | `(R_annual - R_f) / σ_downside` | 只考虑下行波动的风险调整收益（比夏普更合理） |
| **卡尔马比率** | `R_annual / |MaxDrawdown|` | 年化收益与最大回撤之比，衡量回撤恢复能力 |

其中：
- `R_annual` = 年化收益率 = `(1 + 总收益)^(1/年数) - 1`
- `R_f` = 无风险利率 = 2.5%（默认）
- `σ_downside` = 下行波动率 = 仅负收益的标准差年化

---

## 四、第三阶段：多因子计算

> 代码位置：`src/model/factors.py` → `FactorCalculator`

系统计算 **7 大类因子**，每类因子包含多个子指标：

### 4.1 收益因子（Return Factors）

衡量基金的绝对和相对盈利能力。

| 因子名称 | 来源 | 说明 |
|----------|------|------|
| `return_1d` ~ `return_3y` | 净值计算 | 各期绝对收益率 |
| `return_ytd` | 净值计算 | 今年以来收益 |
| `rank_pct_1y` 等 | 同类排名 | 收益在同类基金中的百分位排名（越小越好） |

### 4.2 风险因子（Risk Factors）

衡量基金的风险暴露程度。

| 因子名称 | 说明 |
|----------|------|
| `volatility` | 年化波动率（%），越低越好 |
| `max_drawdown` | 历史最大回撤（%），越接近 0 越好 |
| `downside_volatility` | 下行波动率（%），仅计算负收益的波动 |

### 4.3 风险调整收益因子（Risk-Adjusted Return Factors）

衡量单位风险下的收益能力，是最核心的评价指标。

| 因子名称 | 说明 | 理想值 |
|----------|------|--------|
| `sharpe_ratio` | 夏普比率 | > 1 为良好，> 2 为优秀 |
| `sortino_ratio` | 索提诺比率 | > 1.5 为良好 |
| `calmar_ratio` | 卡尔马比率 | > 1 为良好 |
| `information_ratio` | 信息比率（需要基准数据） | > 0.5 为良好 |
| `alpha` | Jensen Alpha（需要基准数据） | > 0 表示有超额收益 |
| `beta` | 系统性风险系数 | 1 表示与市场同步 |

### 4.4 规模因子（Scale Factors）

衡量基金规模的适宜程度。

| 因子名称 | 说明 |
|----------|------|
| `scale` | 当前规模（亿元） |
| `scale_score` | 规模适中性评分（0-100） |
| `scale_stability` | 规模稳定性（如有历史数据） |

**规模评分逻辑**：

```
2 ~ 100 亿：满分 100（规模适中，流动性好且不影响操作灵活性）
< 2 亿   ：线性降分 = scale / 2 × 100（规模过小，清盘风险）
> 100 亿  ：对数降分 = 100 - log10(scale/100) × 30（规模过大，影响调仓灵活性）
```

### 4.5 动量因子（Momentum Factors）

衡量基金近期的趋势强度和加速度。

| 因子名称 | 说明 |
|----------|------|
| `momentum_20d` | 近 20 个交易日动量 |
| `momentum_60d` | 近 60 个交易日动量 |
| `momentum_120d` | 近 120 个交易日动量 |
| `momentum_250d` | 近 250 个交易日动量 |
| `momentum_acceleration` | 动量加速度 = 短期动量 - 长期月均动量 |

**动量加速度**：`momentum_20d - momentum_60d / 3`，正值表示近期趋势加强。

### 4.6 基金经理因子（Manager Factors）

衡量基金经理的能力和稳定性。

| 因子名称 | 说明 |
|----------|------|
| `manager_tenure` | 当前基金经理任职年限 |
| `manager_experience_score` | 经验评分（0-100） |
| `manager_scale_score` | 管理规模适中性评分 |
| `manager_focus_score` | 管理专注度评分（管理基金数量） |

**经验评分阶梯**：

| 任职年限 | 评分 |
|----------|------|
| ≥ 5 年 | 100 |
| ≥ 3 年 | 80 |
| ≥ 2 年 | 60 |
| < 2 年 | 线性 = tenure / 2 × 60 |

**专注度评分**（管理基金数量越少，精力越集中）：

| 管理数量 | 评分 |
|----------|------|
| 1-3 只 | 100 |
| 4-5 只 | 80 |
| > 5 只 | 100 - (数量 - 3) × 10，最低 50 |

### 4.7 风格稳定性因子（Style Stability Factors）

衡量基金投资风格是否一致，风格漂移是基金常见风险。

| 因子名称 | 计算方法 | 说明 |
|----------|---------|------|
| `style_consistency` | 相邻季度持仓的 Jaccard 相似度 | 持仓重叠度越高越稳定 |
| `beta_stability` | 滚动 60 日 Beta 的标准差 | Beta 波动越小风格越稳定 |
| `return_stability` | 月度收益标准差 + 胜率加权 | 0.7 × 波动稳定性 + 0.3 × 月度胜率 |
| `style_stability_score` | 以上各项均值 | 综合风格稳定性得分 |

**收益稳定性公式**：
```
stability = max(0, 100 - monthly_return_std × 500) × 0.7 + win_rate × 100 × 0.3
```

---

## 五、第四阶段：预筛选（4433 法则）

> 代码位置：`src/model/prefilter.py` → `PreFilter`

预筛选在评分之前执行，过滤掉基本面不达标的基金。系统默认使用 **稳健型（Moderate）** 预筛选器。

### 5.1 规则体系

规则分为 **必须规则** 和 **可选规则** 两类：

#### 必须规则（全部必须通过）

| 规则 | 阈值（稳健型） | 说明 |
|------|---------------|------|
| **最小规模** | ≥ 2 亿元 | 规模过小有清盘风险 |
| **最小成立年限** | ≥ 3 年 | 确保有足够历史数据评估 |

#### 可选规则（至少通过 1/3）

| 规则 | 阈值（稳健型） | 说明 |
|------|---------------|------|
| **基金经理任职** | ≥ 2 年 | 经理稳定性 |
| **最大回撤** | ≥ -35% | 极端风险控制 |
| **增强 4433 法则** | 见下文 | 综合表现筛选 |

### 5.2 4433 法则详解

经典 4433 法则是台湾基金教母邱显比提出的选基方法：

| 代号 | 规则 | 含义 |
|------|------|------|
| 第一个 **4** | 近 1 年收益排名前 **1/4** | 近期表现好 |
| 第二个 **4** | 近 2 年、3 年收益排名前 **1/4** | 中长期表现稳定 |
| 第三个 **3** | 近 6 个月收益排名前 **1/3** | 半年趋势向好 |
| 第四个 **3** | 近 3 个月收益排名前 **1/3** | 短期势头好 |

### 5.3 增强 4433 法则

在经典 4433 基础上增加三项检查：

| 检查项 | 阈值 | 说明 |
|--------|------|------|
| 夏普比率 | > 1 | 风险调整收益达标 |
| 最大回撤 | > -25% | 回撤控制能力 |
| 经理任职 | ≥ 2 年 | 经理稳定性 |

**非严格模式**（默认）：4 项检查中**至少通过 2 项**即可。
**严格模式**：全部通过才算通过。

### 5.4 最终通过条件

```
通过 = 必须规则全部通过 AND 可选规则通过数 ≥ max(1, 可选规则总数 / 3)
```

### 5.5 预设配置对比

| 配置 | 最小规模 | 最小年限 | 经理任职 | 最大回撤 | 4433 | 4433 严格 |
|------|---------|---------|---------|---------|------|----------|
| **保守型** | 5 亿 | 5 年 | 3 年 | -25% | 是 | 是 |
| **稳健型**（默认） | 2 亿 | 3 年 | 2 年 | -35% | 是 | 否 |
| **进取型** | 1 亿 | 2 年 | 1 年 | -50% | 否 | 否 |

---

## 六、第五阶段：加权评分模型

> 代码位置：`src/model/scoring_model.py` → `ScoringModel`

### 6.1 评分流程

```
各因子原始值
    │
    ▼ ① 归一化（0-100 分）
各因子标准化得分
    │
    ▼ ② 类内加权
6 大类别各自得分
    │
    ▼ ③ 类间加权（按基金类型不同配权）
综合得分（0-100）
    │
    ▼ ④ 等级映射
A / B / C / D / E
```

### 6.2 因子归一化

每个因子使用 **线性归一化** 映射到 0-100 分：

```
归一化得分 = (原始值 - 最小值) / (最大值 - 最小值) × 100

如果因子方向为"越低越好"：
归一化得分 = 100 - 归一化得分
```

**各因子归一化参数**：

#### 收益因子组

| 因子 | 方向 | 最小值 | 最大值 | 类内权重 |
|------|------|--------|--------|----------|
| `return_1y`（近 1 年收益） | 越高越好 | -50% | 100% | 40% |
| `return_3y`（近 3 年收益） | 越高越好 | -50% | 200% | 35% |
| `rank_pct_1y`（排名百分位） | 越低越好 | 0 | 100 | 25% |

#### 风险因子组

| 因子 | 方向 | 最小值 | 最大值 | 类内权重 |
|------|------|--------|--------|----------|
| `volatility`（波动率） | 越低越好 | 0% | 50% | 40% |
| `max_drawdown`（最大回撤） | 越小越好 | -50% | 0% | 40% |
| `downside_volatility`（下行波动） | 越低越好 | 0% | 30% | 20% |

#### 风险调整收益因子组

| 因子 | 方向 | 最小值 | 最大值 | 类内权重 |
|------|------|--------|--------|----------|
| `sharpe_ratio`（夏普比率） | 越高越好 | -1 | 3 | 40% |
| `sortino_ratio`（索提诺比率） | 越高越好 | -1 | 4 | 30% |
| `calmar_ratio`（卡尔马比率） | 越高越好 | -1 | 3 | 30% |

#### 规模因子组

| 因子 | 方向 | 最小值 | 最大值 | 类内权重 |
|------|------|--------|--------|----------|
| `scale_score`（规模适中性） | 越高越好 | 0 | 100 | 100% |

#### 基金经理因子组

| 因子 | 方向 | 最小值 | 最大值 | 类内权重 |
|------|------|--------|--------|----------|
| `manager_experience_score`（经验） | 越高越好 | 0 | 100 | 50% |
| `manager_focus_score`（专注度） | 越高越好 | 0 | 100 | 50% |

#### 风格稳定性因子组

| 因子 | 方向 | 最小值 | 最大值 | 类内权重 |
|------|------|--------|--------|----------|
| `style_stability_score`（风格稳定性） | 越高越好 | 0 | 100 | 50% |
| `return_stability`（收益稳定性） | 越高越好 | 0 | 100 | 50% |

### 6.3 类间权重（按基金类型差异化配权）

不同类型基金的评价侧重点不同：

| 因子类别 | 默认 | 主动型（股票/混合） | 指数型 | 债券型 |
|----------|------|-------------------|--------|--------|
| **收益因子** | 25% | 20% | **30%** | 20% |
| **风险因子** | 20% | 15% | 15% | **30%** |
| **风险调整收益** | 25% | **30%** | 20% | 25% |
| **规模因子** | 10% | 10% | **15%** | 10% |
| **基金经理** | 10% | **15%** | 5% | 5% |
| **风格稳定性** | 10% | 10% | **15%** | 10% |

**设计理念**：
- **主动型基金**（股票/混合）：侧重**风险调整收益**（30%）和**基金经理**（15%），因为主动管理的核心是经理的选股择时能力
- **指数型基金**：侧重**收益因子**（30%）和**风格稳定性**（15%），因为指数基金的核心是跟踪精度和低成本
- **债券型基金**：侧重**风险控制**（30%），因为债券基金追求稳健，回撤控制至关重要

### 6.4 综合得分计算

```
类别得分 = Σ(因子归一化得分 × 因子类内权重) / Σ(类内权重)

综合得分 = Σ(类别得分 × 类间权重) / Σ(类间权重)
```

**计算示例**（某股票型基金）：

```
收益因子得分:
  return_1y: 原始值 25% → 归一化 (25-(-50))/(100-(-50))×100 = 50 分
  return_3y: 原始值 60% → 归一化 (60-(-50))/(200-(-50))×100 = 44 分
  类别得分 = 50×0.4 + 44×0.35 = 35.4 / 0.75 = 47.2 分

风险调整收益得分:
  sharpe_ratio: 原始值 1.2 → 归一化 (1.2-(-1))/(3-(-1))×100 = 55 分
  sortino_ratio: 原始值 1.5 → 归一化 (1.5-(-1))/(4-(-1))×100 = 50 分
  calmar_ratio: 原始值 0.8 → 归一化 (0.8-(-1))/(3-(-1))×100 = 45 分
  类别得分 = 55×0.4 + 50×0.3 + 45×0.3 = 50.5 分

综合得分 (主动型配权):
= 47.2×0.20 + 风险得分×0.15 + 50.5×0.30 + 规模得分×0.10 + 经理得分×0.15 + 风格得分×0.10
```

### 6.5 评分等级

| 等级 | 分数范围 | 建议 |
|------|---------|------|
| **A** | ≥ 80 分 | 强烈推荐 — 各项指标表现出色 |
| **B** | 70 - 79 分 | 推荐 — 综合评分良好，适合配置 |
| **C** | 60 - 69 分 | 可考虑 — 综合评分中等，可作为补充配置 |
| **D** | 50 - 59 分 | 谨慎 — 综合评分偏低，需谨慎考虑 |
| **E** | < 50 分 | 不推荐 — 综合评分较差，不建议投资 |

---

## 七、完整工作流串联

> 代码位置：`src/workflow/fund_analysis.py` → `FundAnalysisWorkflow`

### 7.1 全量分析流程

```python
run_full_analysis(fund_types=['股票型', '混合型', '指数型'], top_n=50)
```

| 步骤 | 操作 | 说明 |
|------|------|------|
| Step 1 | 获取基金列表 | 优先从缓存加载（24h 有效），否则从天天基金/AKShare 获取 |
| Step 2 | 可购过滤 | 排除封闭型、场内 ETF 等，约 20,000 只通过 |
| Step 3 | 类型分类 | 按股票/混合/指数/债券分类 |
| Step 4 | 逐类型分析 | 每类取前 200 只，5 线程并发采集数据和计算因子 |
| Step 5 | 预筛选 | 应用 4433 + 硬性指标过滤 |
| Step 6 | 类型化评分 | 使用对应类型的权重配置计算综合得分 |
| Step 7 | 结果存储 | 保存评分到 `data/scores/`，保存报告到 `data/reports/` |

### 7.2 单只基金分析流程

```python
analyze_single_fund(fund_code='000001')
```

| 步骤 | 操作 |
|------|------|
| 1 | 获取净值历史（AKShare，含缓存） |
| 2 | 获取基金基本信息（AKShare，含缓存） |
| 3 | 提取规模、成立年限、经理任职信息 |
| 4 | 计算全部 7 类因子 |
| 5 | 运行预筛选，输出通过/不通过及各规则详情 |
| 6 | 计算综合评分和各类别得分 |
| 7 | 生成投资建议（等级、优势、风险提示） |

### 7.3 数据缓存策略

| 数据类型 | 缓存位置 | 有效期 |
|----------|---------|--------|
| 基金列表 | `data/cache/fund_list_*.json` | 24 小时 |
| 基金详情 | `data/funds/{code}.json` | 7 天 |
| 净值数据 | `data/nav/{code}.csv` | 24 小时 |
| 评分结果 | `data/scores/scores_*_latest.json` | 永久（每次分析覆盖） |

---

## 八、投资建议生成逻辑

> 代码位置：`src/model/scoring_model.py` → `ScoringModel.get_recommendation`

基于综合得分和各因子值，生成结构化建议：

### 优势标签（Reasons）

| 条件 | 标签 |
|------|------|
| 近 1 年收益 > 30% | 近一年收益优秀 |
| 夏普比率 > 1.5 | 风险调整收益出色 |
| 经理任职 ≥ 5 年 | 基金经理经验丰富 |

### 风险提示（Risks）

| 条件 | 标签 |
|------|------|
| 近 1 年收益 < 0 | 近一年收益为负 |
| 最大回撤 < -30% | 最大回撤较大 |
| 波动率 > 30% | 波动率较高 |
| 夏普比率 < 0.5 | 风险调整收益偏低 |
| 经理任职 < 2 年 | 基金经理任期较短 |
| 规模 < 2 亿 | 基金规模偏小 |
| 规模 > 200 亿 | 基金规模过大可能影响灵活性 |

---

## 九、算法特点与局限性

### 特点

1. **多因子体系**：7 大类因子覆盖收益、风险、规模、经理、风格等全方位维度
2. **类型差异化**：不同类型基金采用不同的权重配置，符合各类型投资逻辑
3. **漏斗式筛选**：先硬性过滤再评分排名，提高推荐质量
4. **缓存机制**：多级缓存减少 API 调用，加速分析

### 局限性

1. **数据源限制**：基金排名百分位（`rank_pct_*`）依赖同类基金收益数据，当前未传入同类收益，该因子不参与评分
2. **基准数据缺失**：Alpha、Beta、信息比率需要基准指数数据，当前未接入基准，这些因子不参与评分
3. **经理因子近似**：AKShare 未直接提供经理任职年限，系统使用基金成立时间的一半作为粗略估计
4. **持仓因子缺失**：风格稳定性中的持仓重叠度因子依赖多期持仓数据，当前未采集，仅依赖收益稳定性子因子
5. **样本偏差**：每类基金仅分析前 200 只（按列表顺序），不是随机采样
