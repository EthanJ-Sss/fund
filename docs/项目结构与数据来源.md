# 智能理财助手 - 项目结构与数据来源

## 一、项目概述

智能理财助手是一个基金投资辅助系统，集成了数据采集、量化选基、AI 分析、组合管理、风险控制和消息通知等功能。提供 CLI 命令行和 Flask Web 两种交互方式。

---

## 二、项目目录结构

```
fund/
├── main.py                         # CLI 主程序入口（交互式命令行）
├── web_app.py                      # Flask Web 可视化界面（端口 8080）
├── scheduler.py                    # APScheduler 定时任务调度
├── quick_demo.py                   # 快速演示脚本
├── analyze_top.py                  # 分析热门基金脚本
├── requirements.txt                # Python 依赖清单
│
├── config/
│   ├── __init__.py
│   └── settings.py                 # 全局配置（API、风控、权重、通知等）
│
├── src/
│   ├── __init__.py
│   ├── models.py                   # Pydantic 数据模型定义
│   │
│   ├── collector/                  # 📊 数据采集层
│   │   ├── __init__.py
│   │   ├── fund_data.py            #   天天基金 NAV 数据采集
│   │   ├── eastmoney_collector.py  #   东方财富基金列表、排名、详情
│   │   ├── akshare_collector.py    #   AKShare 基金数据采集
│   │   ├── index_valuation.py      #   蛋卷基金指数估值采集
│   │   ├── market_news.py          #   市场行情与新闻采集
│   │   └── alipay_filter.py        #   支付宝可购基金过滤器
│   │
│   ├── processor/                  # 🔧 数据处理层
│   │   ├── __init__.py
│   │   └── fund_processor.py       #   净值处理、收益计算、风险指标
│   │
│   ├── model/                      # 📐 量化模型层
│   │   ├── __init__.py
│   │   ├── factors.py              #   多因子计算器
│   │   ├── scoring_model.py        #   加权评分模型
│   │   └── prefilter.py            #   4433 预筛选规则
│   │
│   ├── analyzer/                   # 🤖 AI 分析层
│   │   ├── __init__.py
│   │   └── ai_advisor.py           #   OpenAI 驱动的 AI 投资顾问
│   │
│   ├── decision/                   # 🎯 决策引擎层
│   │   ├── __init__.py
│   │   ├── engine.py               #   决策引擎（买卖建议、持仓分析）
│   │   └── risk_control.py         #   风险控制（止盈止损、仓位限制）
│   │
│   ├── portfolio/                  # 💼 组合管理层
│   │   ├── __init__.py
│   │   └── manager.py              #   组合管理（持仓、交易、历史记录）
│   │
│   ├── report/                     # 📝 报告生成层
│   │   ├── __init__.py
│   │   └── daily_report.py         #   每日报告生成（文本 + JSON）
│   │
│   ├── notify/                     # 🔔 消息通知层
│   │   ├── __init__.py
│   │   ├── notifier.py             #   通知管理（邮件、钉钉）
│   │   └── wecom_bot.py            #   企业微信机器人通知
│   │
│   ├── storage/                    # 💾 数据存储层
│   │   ├── __init__.py
│   │   └── fund_storage.py         #   本地存储（基金数据、评分、报告）
│   │
│   └── workflow/                   # 🔄 工作流层
│       ├── __init__.py
│       └── fund_analysis.py        #   端到端量化选基工作流
│
├── data/                           # 本地数据目录
│   ├── portfolio.json              #   组合持仓
│   ├── trade_history.json          #   交易历史
│   ├── watch_list.json             #   关注列表
│   ├── cache/                      #   基金列表缓存
│   ├── daily_reports/              #   每日分析报告
│   ├── funds/                      #   基金元数据（JSON）
│   ├── nav/                        #   净值历史（CSV）
│   ├── reports/                    #   分析报告
│   └── scores/                     #   量化评分结果
│
├── templates/
│   └── index.html                  # Web 界面模板
│
└── docs/                           # 项目文档
    ├── 量化选基模型设计方案.md
    ├── 支付宝基金数据采集系统设计方案.md
    ├── 基金购买与筛选快速指南.md
    └── 企业微信配置指南.md
```

---

## 三、系统架构

```
┌──────────────────────────────────────────────────────────────────┐
│                          入口层                                    │
│   main.py (CLI)   │   web_app.py (Web)   │   scheduler.py (定时)  │
└──────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
        ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
        │ InvestmentAdv│ │ FundAnalysis │ │  Scheduler   │
        │    isor      │ │   Workflow   │ │   定时任务    │
        │  (主编排器)   │ │ (量化选基流程) │ │              │
        └──────┬───────┘ └──────┬───────┘ └──────────────┘
               │                │
    ┌──────────┼────────┬───────┼──────────┬──────────────┐
    ▼          ▼        ▼       ▼          ▼              ▼
┌────────┐┌────────┐┌────────┐┌────────┐┌────────┐┌──────────┐
│Collector││Decision││Analyzer││Portfolio││ Report ││  Notify  │
│数据采集 ││决策引擎 ││AI 分析 ││组合管理 ││报告生成 ││消息通知  │
└───┬────┘└───┬────┘└────────┘└────────┘└────────┘└──────────┘
    │         │
    ▼         ▼
┌────────┐┌────────┐┌────────┐┌────────┐
│Processor││ Model  ││RiskCtrl││Storage │
│数据处理 ││量化模型 ││风险控制 ││数据存储 │
└────────┘└────────┘└────────┘└────────┘
```

---

## 四、数据来源详情

### 1. 天天基金 / 东方财富 (EastMoney)

| 模块 | 接口地址 | 获取数据 |
|------|---------|---------|
| `fund_data.py` | `fundgz.1234567.com.cn/js/{code}.js` | 基金实时估值 |
| `fund_data.py` | `fund.eastmoney.com/pingzhongdata/{code}.js` | 基金详情、基金经理、净值走势 |
| `fund_data.py` | `api.fund.eastmoney.com/f10/lsjz` | 历史净值数据 |
| `eastmoney_collector.py` | `fund.eastmoney.com/js/fundcode_search.js` | 全量基金列表 |
| `eastmoney_collector.py` | `fund.eastmoney.com/data/rankhandler.aspx` | 基金业绩排名 |
| `market_news.py` | `push2.eastmoney.com/api/qt/ulist.np/get` | 大盘指数行情 |
| `market_news.py` | `push2.eastmoney.com/api/qt/clist/get` | 热门行业板块 |
| `market_news.py` | `np-listapi.eastmoney.com/comm/wap/getListInfo` | 财经新闻 |

### 2. AKShare 开源数据库

| 模块 | 调用接口 | 获取数据 |
|------|---------|---------|
| `akshare_collector.py` | `ak.fund_name_em()` | 基金名称列表 |
| `akshare_collector.py` | `ak.fund_open_fund_info_em()` | 净值历史、基金规模 |
| `akshare_collector.py` | `ak.fund_individual_basic_info_xq()` | 基金基本信息 |
| `akshare_collector.py` | `ak.fund_portfolio_hold_em()` | 基金持仓明细 |
| `akshare_collector.py` | `ak.fund_manager_em()` | 基金经理信息 |
| `akshare_collector.py` | `ak.fund_rating_em()` | 基金评级数据 |
| `akshare_collector.py` | `ak.fund_open_fund_rank_em()` | 基金排名数据 |

### 3. 蛋卷基金 (Danjuan)

| 模块 | 接口地址 | 获取数据 |
|------|---------|---------|
| `index_valuation.py` | `danjuanfunds.com/djapi/index_eva/dj` | 指数估值数据（PE、PB、百分位） |

### 4. OpenAI API

| 模块 | 用途 |
|------|------|
| `ai_advisor.py` | AI 市场分析、基金评分、投资建议生成（含规则兜底逻辑） |

### 5. 数据来源关系图

```
外部数据源                          本地处理                      输出
─────────                          ────────                      ────

天天基金 ──┐
           ├─→ 基金列表/净值/排名 ─→ FundDataProcessor ─→ 收益/风险指标
东方财富 ──┘                                │
                                            ▼
AKShare ────→ 持仓/经理/评级 ──────→ FactorCalculator ─→ 多因子得分
                                            │
蛋卷基金 ───→ 指数估值 ───────────→         │
                                            ▼
                                   PreFilter (4433) ───→ 筛选通过列表
                                            │
                                            ▼
                                     ScoringModel ─────→ 综合评分排名
                                            │
OpenAI ─────→ AI 分析建议 ─────────→        │
                                            ▼
                                    FundStorage ────────→ 本地存储 (data/)
                                            │
                                    ┌───────┼───────┐
                                    ▼       ▼       ▼
                                  CLI     Web    通知推送
```

---

## 五、核心模块说明

### 数据采集层 (`src/collector/`)

- **FundDataCollector** — 从天天基金获取单只基金的实时估值和历史净值
- **EastMoneyCollector** — 从东方财富获取基金列表、业绩排名和详情
- **AKShareCollector** — 通过 AKShare 库获取净值历史、持仓、基金经理等数据
- **IndexValuationCollector** — 从蛋卷基金获取指数估值（PE/PB 百分位）
- **MarketNewsCollector** — 获取大盘指数、热门板块和财经新闻
- **AlipayFundFilter** — 过滤出支付宝平台可购买的基金，按类型分类

### 数据处理层 (`src/processor/`)

- **FundDataProcessor** — 净值标准化处理、收益率计算、风险指标计算（波动率、最大回撤、夏普比率、索提诺比率、卡玛比率）、Alpha/Beta 计算

### 量化模型层 (`src/model/`)

- **FactorCalculator** — 多因子计算：收益因子、风险因子、风险调整收益因子、规模因子、动量因子、基金经理因子、风格稳定性因子
- **PreFilter** — 预筛选规则：最小规模、最短存续期、经理最短任期、最大回撤限制、4433 法则
- **ScoringModel** — 按基金类型（指数型/主动型/债券型）配置不同权重进行加权评分

### AI 分析层 (`src/analyzer/`)

- **AIAdvisor** — 调用 OpenAI API 进行市场分析和基金评分，如 API 不可用则回退到规则引擎

### 决策引擎层 (`src/decision/`)

- **DecisionEngine** — 综合分析引擎：异常检测、持仓分析（止盈/止损）、关注列表买入分析
- **RiskController** — 风控模块：熔断机制、仓位限制、买卖校验、组合健康检查

### 工作流层 (`src/workflow/`)

- **FundAnalysisWorkflow** — 完整量化选基流程编排：获取列表 → 过滤 → 因子计算 → 预筛选 → 评分 → 存储

---

## 六、两大核心工作流

### 工作流 A：每日分析（组合 + 关注列表）

```
1. 数据采集：基金净值 + 指数估值 + 市场行情
2. 决策引擎：异常检测 → AI 市场分析 → 持仓分析 → 关注列表分析
3. 风控校验：熔断检查 → 仓位检查 → 买卖限制
4. 报告生成：文本 + JSON 日报
5. 消息推送：邮件 / 企业微信 / 钉钉
```

### 工作流 B：量化选基

```
1. 获取基金列表（EastMoney / AKShare）
2. 支付宝可购过滤（AlipayFundFilter）
3. 数据处理（FundDataProcessor）：净值 → 收益 → 风险指标
4. 多因子计算（FactorCalculator）
5. 预筛选（PreFilter）：规模、存续期、4433 法则
6. 加权评分（ScoringModel）：按基金类型差异化配权
7. 结果存储（FundStorage）：评分排名持久化
```

---

## 七、定时任务调度

| 时间 | 任务 | 说明 |
|------|------|------|
| 每天 09:00 | 早盘数据采集 | 获取最新净值和市场数据 |
| 每天 10:00 | 每日分析 | 运行完整日报分析流程 |
| 每天 11:30 | 盘中检查 | 市场异常监控 |
| 每天 14:30 | 盘中检查 | 市场异常监控 |
| 每天 16:00 | 基金数据更新 | 更新基金列表和净值 |
| 每周日 20:00 | 量化选基 | 运行完整量化筛选流程 |

---

## 八、本地数据存储

所有数据以 JSON 和 CSV 格式存储在 `data/` 目录下：

| 路径 | 内容 |
|------|------|
| `data/portfolio.json` | 当前组合持仓 |
| `data/trade_history.json` | 交易历史记录 |
| `data/watch_list.json` | 基金关注列表 |
| `data/cache/` | 基金列表缓存（减少 API 调用） |
| `data/funds/` | 基金元数据（JSON） |
| `data/nav/` | 基金净值历史（CSV） |
| `data/scores/` | 量化评分结果 |
| `data/reports/` | 分析报告 |
| `data/daily_reports/` | 每日报告存档 |
